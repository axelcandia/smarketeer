doctype html
//
  Template Name: Metronic - Responsive Admin Dashboard Template build with Twitter Bootstrap 3.3.5
  Version: 4.1.0
  Author: KeenThemes
  Website: http://www.keenthemes.com/
  Contact: support@keenthemes.com
  Follow: www.twitter.com/keenthemes
  Like: www.facebook.com/keenthemes
  Purchase: http://themeforest.net/item/metronic-responsive-admin-dashboard-template/4021469?ref=keenthemes
  License: You must have a valid license purchased only from themeforest(the above link) in order to legally use the theme for your project.
//if IE 8
  html.ie8.no-js(lang='en')  
//if IE 9
  html.ie9.no-js(lang='en')  
// [if !IE] <!
html(lang='en')
  // <![endif]
  // BEGIN HEAD
  head
    meta(charset='utf-8')
    title Smarketeer | Todas las visitas
    meta(http-equiv='X-UA-Compatible', content='IE=edge')
    meta(content='width=device-width, initial-scale=1.0', name='viewport')
    meta(http-equiv='Content-type', content='text/html; charset=utf-8')
    meta(content='', name='description')
    meta(content='', name='author')
    // BEGIN GLOBAL MANDATORY STYLES
    link(href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700&subset=all', rel='stylesheet', type='text/css')
    link(href='/global/plugins/font-awesome/css/font-awesome.min.css', rel='stylesheet', type='text/css')
    link(href='/global/plugins/simple-line-icons/simple-line-icons.min.css', rel='stylesheet', type='text/css')
    link(href='/global/plugins/bootstrap/css/bootstrap.min.css', rel='stylesheet', type='text/css')
    link(href='/global/plugins/uniform/css/uniform.default.css', rel='stylesheet', type='text/css')
    link(href='/global/plugins/bootstrap-switch/css/bootstrap-switch.min.css', rel='stylesheet', type='text/css')
    // END GLOBAL MANDATORY STYLES
    // BEGIN PAGE LEVEL STYLES
    link(rel='stylesheet', type='text/css', href='/global/plugins/select2/select2.css') 
    // END PAGE LEVEL STYLES
    // BEGIN THEME STYLES
    link#style_components(href='/global/css/components.css', rel='stylesheet', type='text/css')
    link(href='/global/css/plugins.css', rel='stylesheet', type='text/css')
    link(href='/admin/layout2/css/layout.css', rel='stylesheet', type='text/css')
    link#style_color(href='/admin/layout2/css/themes/grey.css', rel='stylesheet', type='text/css')
    link(href='/admin/layout2/css/custom.css', rel='stylesheet', type='text/css')
    // END THEME STYLES
    link(rel='shortcut icon', href='favicon.ico') 
    script(src='/global/plugins/jquery.min.js', type='text/javascript')
  // END HEAD
  // BEGIN BODY
  // DOC: Apply "page-header-fixed-mobile" and "page-footer-fixed-mobile" class to body element to force fixed header or footer in mobile devices
  // DOC: Apply "page-sidebar-closed" class to the body and "page-sidebar-menu-closed" class to the sidebar menu element to hide the sidebar by default
  // DOC: Apply "page-sidebar-hide" class to the body to make the sidebar completely hidden on toggle
  // DOC: Apply "page-sidebar-closed-hide-logo" class to the body element to make the logo hidden on sidebar toggle
  // DOC: Apply "page-sidebar-hide" class to body element to completely hide the sidebar on sidebar toggle
  // DOC: Apply "page-sidebar-fixed" class to have fixed sidebar
  // DOC: Apply "page-footer-fixed" class to the body element to have fixed footer
  // DOC: Apply "page-sidebar-reversed" class to put the sidebar on the right side
  // DOC: Apply "page-full-width" class to the body element to have full width page without the sidebar menu
  body.page-boxed.page-header-fixed.page-container-bg-solid.page-sidebar-closed-hide-logo
    .page-header.navbar.navbar-fixed-top
      include ../../shared/pageTop
    .clearfix
    // BEGIN CONTAINER
    .container
      .page-container
        include ../../shared/leftBar.jade
        // BEGIN CONTENT
        .page-content-wrapper
          .page-content
            // BEGIN STYLE CUSTOMIZER
            .theme-panel.TrackingCode
              .toggler.tooltips(data-toggle='modal', href='#basic', data-container='body', data-placement='left', data-html='true', data-original-title='Click to see Tracking Pixel Code')
                i.icon-settings 
            // END STYLE CUSTOMIZER
            // CODE MODAL
            
            // BEGIN PAGE HEADER
            h3.page-title
              | Potenciales Clientes 
            .page-bar
              //ul.page-breadcrumb
                li
                  i.fa.fa-home
                  a(href='index') Home
                  i.fa.fa-angle-right
                li
                  a(href='#') Data Tables
                  i.fa.fa-angle-right
                li
                  a(href='#') Advanced Datatables
              .page-toolbar
                .btn-group.pull-right
                  button.btn.btn-fit-height.grey-salt.dropdown-toggle(type='button', data-toggle='dropdown', data-hover='dropdown', data-delay='1000', data-close-others='true')
                    | Exportar 
                    i.fa.fa-angle-down
                  ul.dropdown-menu.pull-right(role='menu')
                    li#toXML
                      a(href='#') Exportar Excel
                    li#toCSV
                      a(href='#') Exportar CSV
                    //li
                      a(href='#') Export to PDF
              .page-toolbar
                #dashboard-report-range.tooltips.btn.btn-fit-height.btn-sm.green-haze.btn-dashboard-daterange(data-container='body', data-placement='left', data-original-title='Change dashboard date range')
                  i.icon-calendar
                  i.fa.fa-angle-down
                  //
                    uncomment this to display selected daterange in the button
                    &nbsp; <span class="thin uppercase visible-lg-inline-block"></span>&nbsp;
                    <i class="fa fa-angle-down"></i>
            // END PAGE HEADER
            // BEGIN PAGE CONTENT
            .row
              //button.try
                | Super boton
              .col-md-12
                // BEGIN EXAMPLE TABLE PORTLET
                .portlet.box.green
                  .portlet-title
                    .caption
                      i.fa.fa-globe
                      | Leads
                    .actions
                      a.saving(href="#")
                        i.fa.fa-save(style="margin-right:26px")
                          |  Guardar
                      .btn-group
                        a.btn.default(href='javascript:;', data-toggle='dropdown')
                          | Columns 
                          i.fa.fa-angle-down
                        #sample_4_column_toggler.dropdown-menu.hold-on-click.dropdown-checkboxes.pull-right
                          label
                            input(type='checkbox', checked='', data-column='0')
                            | Fecha
                          label
                            input(type='checkbox', checked='', data-column='0')
                            | E-mail
                          label
                            input(type='checkbox', checked='', data-column='1')
                            | Campaña
                          label
                            input(type='checkbox', checked='', data-column='2')
                            | Fuente
                          label
                            input(type='checkbox', checked='', data-column='3')
                            | Medium
                          label
                            input(type='checkbox', checked='', data-column='4')
                            | Contenido
                          label
                            input(type='checkbox', checked='', data-column='5')
                            | URL del referido
                          label
                            input(type='checkbox', checked='', data-column='6')
                            | Página de destino
                          label
                            input(type='checkbox', checked='', data-column='8')
                            | Venta
                          //label
                            input(type='checkbox', checked='', data-column='9')
                            | Status
                  .portlet-body
                    table#sample_4.table.table-striped.table-bordered.table-hover
                      thead
                        tr
                          th.hidden-xs
                            | Fecha
                          th.hidden-xs
                            | E-mail
                          th.hidden-xs
                            | Campaña
                          th.hidden-xs
                            | Fuente
                          th.hidden-xs
                            | Medio
                          th.hidden-xs
                            | Contenido
                          th.hidden-xs
                            | Referido
                          th.hidden-xs
                            | Página Destino
                          th.hidden-xs
                            | Venta
                          //th.hidden-xs
                            | Status
                      tbody#tleads
                // END EXAMPLE TABLE PORTLET
            // END PAGE CONTENT
        // END CONTENT
        // BEGIN QUICK SIDEBAR
        // Cooming Soon...
        // END QUICK SIDEBAR
      // END CONTAINER
    // BEGIN JAVASCRIPTS(Load javascripts at bottom, this will reduce page load time)
    // BEGIN CORE PLUGINS
    //if lt IE 9
      script(src='/global/plugins/respond.min.js')
      script(src='/global/plugins/excanvas.min.js')    script(src='/global/plugins/jquery-migrate.min.js', type='text/javascript')
    // IMPORTANT! Load jquery-ui.min.js before bootstrap.min.js to fix bootstrap tooltip conflict with jquery ui tooltip
    script(src='/global/plugins/jquery-ui/jquery-ui.min.js', type='text/javascript')
    script(src='/global/plugins/bootstrap/js/bootstrap.min.js', type='text/javascript')
    script(src='/global/plugins/bootstrap-hover-dropdown/bootstrap-hover-dropdown.min.js', type='text/javascript')
    script(src='/global/plugins/jquery-slimscroll/jquery.slimscroll.min.js', type='text/javascript')
    script(src='/global/plugins/jquery.blockui.min.js', type='text/javascript')
    script(src='/global/plugins/jquery.cokie.min.js', type='text/javascript')
    script(src='/global/plugins/uniform/jquery.uniform.min.js', type='text/javascript')
    script(src='/global/plugins/bootstrap-switch/js/bootstrap-switch.min.js', type='text/javascript')
    //script(src='/global/plugins/floathead/float.js', type='text/javascript')
    // END CORE PLUGINS
    // BEGIN PAGE LEVEL PLUGINS 
    // END PAGE LEVEL PLUGINS
    // BEGIN PAGE LEVEL SCRIPTS 
    script(src='/global/scripts/metronic.js', type='text/javascript')
    script(src='/admin/layout2/scripts/layout.js', type='text/javascript')
    script(src='/admin/layout2/scripts/demo.js', type='text/javascript')
    script(src="/global/plugins/export/jquery.tabletoCSV.js", type='text/javascript') 
    script.
      $( document ).ready(function(){ 

          $("#toXML").click(function(){
        $.ajax({
          url:"/leads/Export",
          data: {"idSite":idSite}, 
          method: "POST",
          success: function(data){
          window.open('data:application/vnd.ms-excel,' +"<table>"+data+"</table>");
          }
        })
      });

      $("#toCSV").click(function(){
        $.ajax({
          url:"/leads/Export",
          data: {"idSite":idSite}, 
          method: "POST",
          success: function(data){  
          var table = "<table>"+
          data+
          "</table>";
           $(table).tableToCSV();
          }
        })
      });


          var page=0;
          var loading= false;
          var enable = true;
          //This is the typical structure of a buy
          
          //Getting the first leads
          GetMoreLeads();
          //Detecting infintie scroll
          $('.portlet-body').bind('scroll', function(){
             if($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight){
                 $('#loading').show();
                 if( enable && !loading){
                    loading=true;
                    GetMoreLeads(); 
                  }
              }
          });
          //Inifnite scroll2
          function GetMoreLeads(){
          console.log("idsite:"+idSite);
            $.ajax({
                      url: '/home/funnel/GetLeads', 
                      method: "POST",
                      data: { "page" :  page,
                              "idSite": idSite },
                      success: function(data) {
                        page++;   
                        $('#tleads').append(data);
                        if(!data) enable=false; 
                        loading=false;

                      },
                       error: function(XMLHttpRequest, textStatus, errorThrown) {
                           console.log("error");
                        }
                    }); 
            } 
            UpdateSubtotal();
          $( ".iva input:checkbox" ).on( "click", function(){
          UpdateSubtotal()
            }
           );
           $(document).on("click",".iva",UpdateSubtotal);

          //Updating the ticket stuff
          function UpdateSubtotal(){
            var subtotal=0; 
            $( ".subtotal1" ).each(function() { 
                subtotal+=parseFloat($( this ).html()) || 0;
              });  
            $("#subtotal").html("$"+subtotal);
            //ADD the iva
            var iva = ($( ".iva:checked" ).length >0 ) ? subtotal*0.21 : 0 ; 
            $(".totalIVA").html("$"+iva.toFixed(2));
            //Add the total value
            $("#total").html("$"+(iva+subtotal).toFixed(2));
          }
          //Updating unidades y tarifa
          $(document).on('change',".unidades, .tarifa", function(){   
              var unidades = parseFloat($(this).closest('tr').find('.unidades').val()) || 0;
              var costo    = parseFloat($(this).closest('tr').find('.tarifa').val()) || 0;  
              $(this).closest('tr').find('.subtotal1').html(unidades*costo);
              UpdateSubtotal();

            });   
        }); 
        //Add a new item on click
        $(document).on("click",".agregar_item",function(){
          $("#tbody tr:last").after('<tr>'+
                        '<td><input class="factura-inp servicio" type="text" placeholder="Artículo"></td>'+
                        '<td><input class="factura-inp descripcion" type="text" placeholder="Título de su artículo aquí"></td>'+
                        '<td class=" text-right ">'+
                          '<input type="number" placeholder="Unidades" class="factura-inp unidades"> ' +
                        '</td>'+
                        '<td class=" text-right ">'+
                          '<input id="name" name="name" type="number" placeholder="Tarifa/Precio" class="factura-inp tarifa"> ' +
                        '<td class=" text-right subtotal1 ">'+
                        '</td>'+
                      '</tr>');
        });


        //Bootbox for sales
        $(document).on("click",".try", function(){ 
          var ClientId = $(this).attr('id'); 
          var SellerId ="20";
          var total = $(".totalIVA").html();
          var email = $(this).attr('data-email');  
          bootbox.dialog({ 
                backdrop: true,
                onEscape: true,
                className: "ticketAlert", 
                message: function(){ 
                var factura='<div class="col-xs-6">'+
                  '<h1><a href=" "><img class="logos" alt="" src="/logo.png" /></a>'+
                  '</h1>'+
                '</div>'+
                '<div class="col-xs-6 text-right">'+
                  '<h1>Venta</h1>'+
                '</div>'+
                  "<div class='seller'>"+
                    '<h4>Vendedor:<input id="Vendedor"class="factura-inp" type="text" placeholder="Escriba su nombre"></h4>'+
                  "</div>"+
                /*
                '<div class="row">'+
                  '<div class="col-xs-5">'+
                    '<div class="panel panel-default">'+
                      '<div class="panel-heading">'+
                        '<h4>De: <a href="#"></a></h4>'+
                      '</div>'+
                      '<div class="panel-body"><p>Dirección:</p>'+
                        '<p>Dia:</p>'+
                        '<p>Algun detalle</p></div>'+
                      '</div>'+
                    '</div>'+
                      '<div class="col-xs-5 col-xs-offset-2 text-right">'+
                        '<div class="panel panel-default">'+
                          '<div class="panel-heading">'+
                            '<h4>Para : <a href="#">Nombre del Cliente</a></h4>'+
                          '</div>'+
                        '<div class="panel-body"><p>Dirección</p>'+
                          '<p>detalles</p>'+
                          '<p>más detalles</p></div>'+
                        '</div>'+
                      '</div>'+
                    '</div>'+*/ 
                  '<table class="table table-bordered" id="tfactura">'+
                    '<thead>'+
                      '<tr>'+
                        '<th>'+
                          '<h4>Servicio</h4>'+
                        '</th>'+
                        '<th>'+
                          '<h4>Descripción</h4>'+
                        '</th>'+
                        '<th>'+
                          '<h4>Hrs / Cantidad</h4>'+
                        '</th>'+
                        '<th>'+
                          '<h4>Tarifa / Precio</h4>'+
                        '</th>'+
                        '<th>'+
                          '<h4>Sub-Total</h4>'+
                        '</th>'+
                      '</tr>'+
                    '</thead>'+
                    '<tbody id="tbody">'+
                      '<tr>'+
                        '<td><input class="factura-inp servicio" type="text" placeholder="Artículo"></td>'+
                        '<td><input class="factura-inp descripcion" type="text" placeholder="Título de su artículo aquí"></td>'+
                        '<td class=" text-right ">'+
                          '<input type="number" placeholder="Unidades" class="factura-inp unidades"> ' +
                        '</td>'+
                        '<td class=" text-right ">'+
                          '<input id="name" name="name" type="number" placeholder="Tarifa/Precio" class="factura-inp tarifa"> ' +
                        '<td class=" text-right subtotal1 ">'+
                        '</td>'+
                      '</tr>'+
                    '</tbody>'+
                  '</table>'+
                   '<div class="agregar">'+
                     '<a href="#" class="agregar_item">'+
                        '<i class="fa fa-plus"></i>'+
                        'Agregar item'+
                      '</a>'+
                   '</div>'+
                '<div class="row text-right">'+
                  '<div class="col-xs-3 col-xs-offset-7"><strong>'+
                  '<p>Sub Total:</p>'+
                  '<p><input type="checkbox" name="iva" class="iva"> Impuestos (IVA 21%):</p>'+
                  '<p>Total:</p>'+
                  '</strong></div>'+
                  '<div class="col-xs-2"><strong>'+
                '<p id="subtotal">$0</p>'+
                '<p class="totalIVA">$0</p>'+
                '<p id="total">$0</p>'+
                '</strong></div>'+
                '</div>'/*+
                '<div class="row">'+
                '<div class = "col-xs-5">'+
                  '<div class="panel panel-info">'+
                    '<div class="panel-heading">'+
                    '<h4>Datos bancarios</h4>'+
                    '</div>'+
                    '<div class="panel-body">'+
                     '<p>Su nombre</p>'+
                     '<p>Nombre del banco</p>'+
                     '<p>SWIFT: -------</p>'+
                     '<p>Número de cuenta: 12345678</p>'+
                     '<p>IBAN: ------</p></div>'+
                    '</div>'+
                  '</div>'+
                '</ div>'+
                '<div class="col-xs-7">'+
                '<div class="span7">'+
                  '<div class="panel panel-info">'+
                  '<div class="panel-heading">'+
                  '<h4> Datos de contacto </h4>'+
                  '</div>'+
                  '<div class=" panel-body ">'+
                   '<p>Email: usted@ejemplo.com</p>'+
                   '<p>Móvil: +92123456789</p>'+
                  '<h4><small> El pago debe ser por transferencia bancaria </h4>'+
                  '</div>'+
                  '</div>'+
                  '</div>'+
                '</div>'+
                '</div>'*/;
                return factura;
                },
                buttons: {
                    success: {
                        label: "Guardar",
                        className: "btn-success exito",
                        callback: function () {  
                          var  compra ={
                            "idSite": idSite,
                            "ClientId":ClientId,
                            "ClientEmail":email, 
                            "SellerName":$("#Vendedor").val(), 
                            "Total":$("#total").html().replace("$",""),
                            "IVA":$(".totalIVA").html().replace("$",""),  
                          }
                          /**
                          * Read every row and convert it in json
                          */
                          var myRows = [];
                          var headersText = [];
                          var $headers = $("#tfactura thead th");

                          // Loop through grabbing everything
                          var $rows = $("#tfactura tbody tr").each(function(index) {
                            $cells = $(this).find("td");
                            myRows[index] = {}; 
                            $cells.each(function(cellIndex) {
                              // Set the header text
                              if(headersText[cellIndex] === undefined) {
                                headersText[cellIndex] = $($headers[cellIndex]).text();
                              }
                              var child = $(this).children().val();
                              // Update the row object with the header/cell combo
                              myRows[index][headersText[cellIndex]] =  (child) ? child : $(this).text();
                            });    
                          });
                          compra.compras=myRows;
                          // Let's put this in the object like you want and convert to JSON (Note: jQuery will also do this for you on the Ajax request)
                          $.ajax({
                            url:"/home/funnel/leads/GetSale",
                            data:JSON.stringify(compra),
                            method: "POST",
                            contentType: 'application/json; charset=utf-8',
                            success: function(data){
                              console.log(data); 
                            }
                          });
                        }
                    }
                }
            });

        }); 
    style.
        .portlet-body{ 
          overflow-y: scroll;
          height: 400px;  
        }
        .fa-save{
          color:white; 
        }
        .saving{
        display:none;
        }
        .fa-save:hover{
          color:black;
        }
        .ticketAlert > .modal-dialog {
            width:70% !important;
        }
        .tfactura{
          margin-top: 34px
        } 
        .factura-inp{
        border: 0;
        outline:0px !important;
        -webkit-appearance:none;
        }
        .logos{
        height: 50px;
        }
        .table-bordered{
           margin-bottom: 0px!important;
        }
        .agregar{
          padding-top: 5px; 
          text-align: center;
          font-family: "Open Sans", sans-serif;  
              margin-bottom: 50px
        }
        .seller{
            padding-bottom: 6%;
            padding-top: 12%;
        }
    
